<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <title>Add Inventory Item</title>
    <link rel="stylesheet" href="/bootstrap.min.css" />
  </head>
  <body>
    <div class="container py-4">
      <div class="mb-3">
        <a class="btn btn-outline-primary" href="/home-<%= appId %>?userId=<%= userId %>">Return to Home</a>
      </div>

      <h1 class="text-center mb-1">+ Add Inventory Item</h1>
      <p class="text-center text-muted mb-4">
        Share your pantry additions with detailed information
      </p>

      <form action="/add-inventory-<%= appId %>" method="POST">

        <!-- card 1 capture the key identifiers for the new inventory item -->
        <div class="card mb-4">
          <div class="card-header">Basic Information</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Inventory ID</label>
                <input class="form-control" type="text" name="inventoryId" required placeholder="I-00005" />
                <div class="form-text">Format: I-#####</div>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">User ID</label>
                <div class="form-control-plaintext fw-semibold"><%= defaultUserId %></div>
                <input type="hidden" name="userId" value="<%= defaultUserId %>" />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Ingredient Name</label>
                <input class="form-control" type="text" name="ingredientName" required />
              </div>
            </div>
          </div>
        </div>

        <!-- card 2 core quantitative details about the inventory item -->
        <div class="card mb-4">
          <div class="card-header">Item Details</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">Quantity</label>
                <input class="form-control" type="number" name="quantity" step="0.01" min="0.01" required />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Unit</label>
                <select class="form-select" name="unit" required>
                  <option value="">-- choose --</option>
                  <!-- loop through the units array provided by the server to populate options -->
                  <% for (let i = 0; i < units.length; i++) { %>
                    <option value="<%= units[i] %>"><%= units[i] %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" name="category" required>
                  <option value="">-- choose --</option>
                  <!-- categories is another EJS array that comes from the route handler -->
                  <% for (let i = 0; i < categories.length; i++) { %>
                    <option value="<%= categories[i] %>"><%= categories[i] %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Cost</label>
                <input class="form-control" type="number" name="cost" step="0.01" min="0.01" required />
              </div>
            </div>
          </div>
        </div>

        <!-- card 3 track the important dates for this ingredient -->
        <div class="card mb-4">
          <div class="card-header">Dates</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Purchase Date</label>
                <input class="form-control" type="date" name="purchaseDate" required />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Expiration Date</label>
                <input class="form-control" type="date" name="expirationDate" required />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Created Date</label>
                <input class="form-control" type="date" name="createdDate" />
              </div>
            </div>
          </div>
        </div>

        <!-- card 4 the storage location ties into inventory filtering elsewhere -->
        <div class="card mb-4">
          <div class="card-header">Location</div>
          <div class="card-body">
            <select class="form-select" name="location" required>
              <option value="">-- choose --</option>
              <!-- populate the select element with all available locations -->
              <% for (let i = 0; i < locations.length; i++) { %>
                <option value="<%= locations[i] %>"><%= locations[i] %></option>
              <% } %>
            </select>
            <div class="form-text">Must be one of the listed storage locations.</div>
          </div>
        </div>

        <!-- final  buttons for navigation and submission -->
        <div class="d-flex justify-content-between">
          <a class="btn btn-outline-secondary" href="/inventory-dashboard-<%= appId %>?userId=<%= userId %>">View Inventory</a>
          <button class="btn btn-primary" type="submit">Add Item</button>
        </div>
      </form>
      <script>
        (function () {
          // store the app ID locally so we can re-use
          const APP_ID = '<%= appId %>';

          // cache commonly used form elements once instead of querying repeatedly
          const form = document.querySelector('form');
          if (!form) return;

          const idInput = form.querySelector('input[name="inventoryId"]');
          const qtyInput = form.querySelector('input[name="quantity"]');
          const costInput = form.querySelector('input[name="cost"]');
          const purchaseDateInput = form.querySelector('input[name="purchaseDate"]');
          const expirationDateInput = form.querySelector('input[name="expirationDate"]');

          // hit the inventory API to make sure the ID has not been taken yet
          function checkDuplicate(cb) {
            idInput.setCustomValidity('');
            const want = (idInput.value || '').trim();
            if (!want) { cb(false); return; }
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/inventory-dashboard-' + APP_ID, true);
            xhr.onreadystatechange = function () {
              if (xhr.readyState === 4) {
                let isDup = false;
                if (xhr.status >= 200 && xhr.status < 300) {
                  try {
                    const data = JSON.parse(xhr.responseText || '{}');
                    const list = (data && data.items) ? data.items : [];
                    for (let i = 0; i < list.length; i++) {
                      const it = list[i];
                      if (it && it.inventoryId === want) { isDup = true; break; }
                    }
                  } catch (e) {}
                }
                if (isDup) {
                  idInput.setCustomValidity('Inventory ID already exists.');
                }
                cb(isDup);
              }
            };
            try { xhr.send(); } catch (e) { cb(false); }
          }

          // guard against invalid numeric inputs and date ranges
          function validateNumbers() {
            qtyInput.setCustomValidity('');
            costInput.setCustomValidity('');
            expirationDateInput.setCustomValidity('');

            const q = Number(qtyInput.value);
            if (!Number.isFinite(q) || q <= 0) {
              qtyInput.setCustomValidity('Quantity must be positive.');
            }

            const c = Number(costInput.value);
            if (!Number.isFinite(c) || c <= 0) {
              costInput.setCustomValidity('Cost must be more than 0.');
            }

            if (purchaseDateInput.value && expirationDateInput.value) {
              const pd = new Date(purchaseDateInput.value);
              const ed = new Date(expirationDateInput.value);
              if (ed <= pd) {
                expirationDateInput.setCustomValidity('Expiration must be after purchase.');
              }
            }
          }

          idInput.addEventListener('input', function () {
            idInput.setCustomValidity('');
          });
          idInput.addEventListener('blur', function () {
            checkDuplicate(function () {
              if (idInput.reportValidity) idInput.reportValidity();
            });
          });
          qtyInput.addEventListener('input', validateNumbers);
          costInput.addEventListener('input', validateNumbers);
          purchaseDateInput.addEventListener('change', validateNumbers);
          expirationDateInput.addEventListener('change', validateNumbers);

          form.addEventListener('submit', function (e) {
            e.preventDefault();
            validateNumbers();
            checkDuplicate(function () {
              if (form.checkValidity()) {
                form.submit();
              } else if (form.reportValidity) {
                form.reportValidity();
              }
            });
          });
        })();
      </script>

    </div>
  </body>
</html>