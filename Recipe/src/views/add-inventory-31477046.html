<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <title>Add Inventory Item</title>
    <link rel="stylesheet" href="/bootstrap.min.css" />
  </head>
  <body>
    <div class="container py-4">
      <h1 class="text-center mb-1">+ Add Inventory Item</h1>
      <p class="text-center text-muted mb-4">
        Share your pantry additions with detailed information
      </p>

      <form action="/add-inventory-31477046" method="POST">

        <div class="card mb-4">
          <div class="card-header">Basic Information</div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Inventory ID</label>
              <input class="form-control" type="text" name="inventoryId" required placeholder="I-31477046-003" />
            </div>
            <div class="mb-3">
              <label class="form-label">User ID</label>
              <input class="form-control" type="text" name="userId" required placeholder="Your named" />
            </div>
            <div class="mb-3">
              <label class="form-label">Ingredient Name</label>
              <input class="form-control" type="text" name="ingredientName" required />
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">Item Details</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">Quantity</label>
                <input class="form-control" type="number" name="quantity" step="0.01" min="0" required />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Unit</label>
                <input class="form-control" type="text" name="unit" required placeholder="g, ml, L, kg, pcs, ..." />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Category (optional)</label>
                <input class="form-control" type="text" name="category" placeholder="Dairy, Grains, Produce..." />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Cost</label>
                <input class="form-control" type="number" name="cost" step="0.01" min="0" required />
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">Dates</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Purchase Date</label>
                <input class="form-control" type="date" name="purchaseDate" />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Expiration Date</label>
                <input class="form-control" type="date" name="expirationDate" />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Created Date</label>
                <input class="form-control" type="date" name="createdDate" />
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">Location</div>
          <div class="card-body">
            <select class="form-select" name="location" required>
              <option value="">-- choose --</option>
              <option>Pantry</option>
              <option>Fridge</option>
              <option>Freezer</option>
            </select>
            <div class="form-text">Must be Pantry, Fridge, or Freezer.</div>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <a class="btn btn-outline-secondary" href="/inventory-dashboard-31477046">View Inventory</a>
          <button class="btn btn-primary" type="submit">Add Item</button>
        </div>
      </form>
      <script>
        (function () {
          const APP_ID = '31477046';
      
          const form = document.querySelector('form');
          if (!form) return;
      
          const idInput = form.querySelector('input[name="inventoryId"]');
          const qtyInput = form.querySelector('input[name="quantity"]');
          const costInput = form.querySelector('input[name="cost"]');
          const purchaseDateInput = form.querySelector('input[name="purchaseDate"]');
          const expirationDateInput = form.querySelector('input[name="expirationDate"]');
          function checkDuplicate(cb) {
            idInput.setCustomValidity('');
            const want = (idInput.value || '').trim();
            if (!want) { cb(false); return; }
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/inventory-' + APP_ID, true);
            xhr.onreadystatechange = function () {
              if (xhr.readyState === 4) {
                const isDup = false;
                if (xhr.status >= 200 && xhr.status < 300) {
                  try {
                    const data = JSON.parse(xhr.responseText || '{}');
                    const list = (data && data.items) ? data.items : [];
                    for (let i = 0; i < list.length; i++) {
                      const it = list[i];
                      if (it && it.inventoryId === want) { isDup = true; break; }
                    }
                  } catch (e) {}
                }
                if (isDup) {
                  idInput.setCustomValidity('Inventory ID already exists.');
                }
                cb(isDup);
              }
            };
            try { xhr.send(); } catch (e) { cb(false); }
          }

          function validateNumbers() {
            qtyInput.setCustomValidity('');
            costInput.setCustomValidity('');
            expirationDateInput.setCustomValidity('');
            const q = Number(qtyInput.value);
            if (!isFinite(q) || q <= 0) {
              qtyInput.setCustomValidity('Quantity must be positive.');
            }
      
            const c = Number(costInput.value);
            if (!isFinite(c) || c < 0) {
              costInput.setCustomValidity('Cost must be non-negative.');
            }
      
            if (purchaseDateInput.value && expirationDateInput.value) {
              const pd = new Date(purchaseDateInput.value);
              const ed = new Date(expirationDateInput.value);
              if (ed < pd) {
                expirationDateInput.setCustomValidity('Expiration cannot be before purchase.');
              }
            }
      
          }

          idInput.addEventListener('input', function () {
            idInput.setCustomValidity('');
          });
          idInput.addEventListener('blur', function () {
            checkDuplicate(function () {
              if (idInput.reportValidity) idInput.reportValidity();
            });
          });
          qtyInput.addEventListener('input', validateNumbers);
          costInput.addEventListener('input', validateNumbers);
          purchaseDateInput.addEventListener('change', validateNumbers);
          expirationDateInput.addEventListener('change', validateNumbers);

          form.addEventListener('submit', function (e) {
            e.preventDefault();
            validateNumbers();
            checkDuplicate(function () {
              if (form.checkValidity()) {
                form.submit();
              } else {
                if (form.reportValidity) { form.reportValidity(); }
              }
            });
          });
        })();
      </script>
      
    </div>
  </body>
</html>
