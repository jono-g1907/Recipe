<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <title>Add Inventory Item</title>
    <link rel="stylesheet" href="/bootstrap.min.css" />
  </head>
  <body>
    <div class="container py-4">
      <div class="mb-3">
        <a class="btn btn-outline-secondary" href="/">Home</a>
        <a class="btn btn-primary" href="/inventory-dashboard">View Inventory</a>
      </div>

      <h3>Add Inventory Item</h3>

      <form action="/add-inventory" method="POST" class="mt-3">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Inventory ID</label>
            <input class="form-control" type="text" name="inventoryId" required placeholder="I-31477046-003" />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">User ID</label>
            <input class="form-control" type="text" name="userId" required placeholder="YourName-31477046" />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Ingredient Name</label>
            <input class="form-control" type="text" name="ingredientName" required />
          </div>
        </div>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Quantity</label>
            <input class="form-control" type="number" name="quantity" step="0.01" min="0" required />
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Unit</label>
            <input class="form-control" type="text" name="unit" required placeholder="g, ml, L, kg, pcs, ..." />
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Category (optional)</label>
            <input class="form-control" type="text" name="category" placeholder="Dairy, Grains, Produce..." />
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Cost</label>
            <input class="form-control" type="number" name="cost" step="0.01" min="0" required />
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Purchase Date</label>
            <input class="form-control" type="date" name="purchaseDate" />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Expiration Date</label>
            <input class="form-control" type="date" name="expirationDate" />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Created Date</label>
            <input class="form-control" type="date" name="createdDate" />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Location</label>
          <select class="form-select" name="location" required>
            <option value="">-- choose --</option>
            <option>Pantry</option>
            <option>Fridge</option>
            <option>Freezer</option>
          </select>
          <div class="form-text">Must be Pantry, Fridge, or Freezer.</div>
        </div>

        <button class="btn btn-success" type="submit">Create Item</button>
      </form>
      <script>
        // client-side validation for add inventory
        (function () {
          var APP_ID = '31477046';
      
          var form = document.querySelector('form');
          if (!form) return;
      
          var idInput = form.querySelector('input[name="inventoryId"]');
          var ingredientNameInput = form.querySelector('input[name="ingredientName"]');
          var quantityInput = form.querySelector('input[name="quantity"]');
          var unitInput = form.querySelector('input[name="unit"]');
          var purchaseDateInput = form.querySelector('input[name="purchaseDate"]');
          var expirationDateInput = form.querySelector('input[name="expirationDate"]');
          var costInput = form.querySelector('input[name="cost"]');
      
          // helper to clear sticky errors
          function clearOnInput(el) {
            if (!el) return;
            el.addEventListener('input', function () {
              el.setCustomValidity('');
            });
            // also clear on change for date/number fields
            el.addEventListener('change', function () {
              el.setCustomValidity('');
            });
          }
      
          clearOnInput(idInput);
          clearOnInput(ingredientNameInput);
          clearOnInput(quantityInput);
          clearOnInput(unitInput);
          clearOnInput(purchaseDateInput);
          clearOnInput(expirationDateInput);
          clearOnInput(costInput);
      
          form.addEventListener('submit', function (e) {
            e.preventDefault();
      
            // reset messages each submit
            if (idInput) idInput.setCustomValidity('');
            if (ingredientNameInput) ingredientNameInput.setCustomValidity('');
            if (quantityInput) quantityInput.setCustomValidity('');
            if (unitInput) unitInput.setCustomValidity('');
            if (purchaseDateInput) purchaseDateInput.setCustomValidity('');
            if (expirationDateInput) expirationDateInput.setCustomValidity('');
            if (costInput) costInput.setCustomValidity('');
      
            // required text fields
            if (ingredientNameInput && !ingredientNameInput.value.trim()) {
              ingredientNameInput.setCustomValidity('Ingredient name is required');
            }
            if (unitInput && !unitInput.value.trim()) {
              unitInput.setCustomValidity('Unit is required');
            }
      
            // quantity must be a positive number
            if (quantityInput) {
              const qty = Number((quantityInput.value || '').trim());
              if (!isFinite(qty) || qty <= 0) {
                quantityInput.setCustomValidity('Quantity must be a positive number');
              }
            }
      
            // cost non-negative if provided
            if (costInput && costInput.value.trim() !== '') {
              const c = Number((costInput.value || '').trim());
              if (!isFinite(c) || c < 0) {
                costInput.setCustomValidity('Cost must be a non-negative number');
              }
            }
      
            // expirationDate >= purchaseDate (if both given)
            if (purchaseDateInput && expirationDateInput &&
                purchaseDateInput.value && expirationDateInput.value) {
              const pd = new Date(purchaseDateInput.value);
              const ed = new Date(expirationDateInput.value);
              if (ed < pd) {
                expirationDateInput.setCustomValidity('Expiration date cannot be before purchase date');
              }
            }
      
            // duplicate check for inventoryId 
            // if network fails, we ignore and let server validate
            fetch('/api/inventory-' + APP_ID)
              .then(function (res) {
                if (!res.ok) return null;
                return res.json();
              })
              .then(function (data) {
                if (!data || !idInput) return;
      
                const list = data.inventory || data.items || data || [];
                for (let i = 0; i < list.length; i++) {
                  const it = list[i] || {};
                  if (it.inventoryId === id) {
                    idInput.setCustomValidity('Inventory ID already exists');
                    break;
                  }
                }
              })
              .catch(function () {
                // ignore network errors
              })
              .finally(function () {
                // show messages if any, otherwise submit
                if (!form.checkValidity()) {
                  form.reportValidity();
                  return;
                }
                form.submit();
              });
          });
        })();
      </script>
      
    </div>
  </body>
</html>
