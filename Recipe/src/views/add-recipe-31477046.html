<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <title>Add New Recipe</title>
    <link href="/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container py-4">
      <div class="mb-3">
        <a class="btn btn-outline-primary" href="/home-<%= appId %>?userId=<%= userId %>">Return to Home</a>
      </div>

      <h1 class="text-center mb-1">+ Add Recipe</h1>
      <p class="text-center text-muted mb-4">
        Share your culinary creation with detailed instructions and ingredients
      </p>

      <!-- validation error message passed down from the server -->
      <div class="alert alert-danger" style="<%= error ? '' : 'display:none;' %>"><%= error %></div>

      <!-- POST the completed form back to the add recipe route -->
      <form action="/add-recipe-<%= appId %>" method="POST">

        <!-- section 1 high level metadata about the recipe -->
        <div class="card mb-4">
          <div class="card-header">Basic Information</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Recipe Title</label>
                <input class="form-control" type="text" name="title" required value="<%= values.title %>" />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Recipe ID</label>
                <input class="form-control" type="text" name="recipeId" required placeholder="R-00005" value="<%= values.recipeId %>" />
                <div class="form-text">Format: R-#####</div>
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">User ID</label>
                <!-- display the current user's ID while also submitting it with the form -->
                <div class="form-control-plaintext fw-semibold"><%= defaultUserId %></div>
                <input type="hidden" name="userId" value="<%= defaultUserId %>" />
                <div class="form-text">Automatically linked to your account.</div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Chef</label>
                <input class="form-control" type="text" name="chef" required placeholder="Your name" value="<%= values.chef %>" />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Meal Type</label>
                <select class="form-select" name="mealType" required>
                  <option value="">-- choose --</option>
                  <!-- create an option for every supported meal type and pre-select the saved value -->
                  <% for (let i = 0; i < mealTypes.length; i++) { %>
                    <option value="<%= mealTypes[i] %>" <%= values.mealType === mealTypes[i] ? 'selected' : '' %>><%= mealTypes[i] %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Cuisine Type</label>
                <select class="form-select" name="cuisineType" required>
                  <option value="">-- choose --</option>
                  <!-- cuisineTypes is provided by the controller, this loop renders each choice -->
                  <% for (let i = 0; i < cuisineTypes.length; i++) { %>
                    <option value="<%= cuisineTypes[i] %>" <%= values.cuisineType === cuisineTypes[i] ? 'selected' : '' %>><%= cuisineTypes[i] %></option>
                  <% } %>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Difficulty</label>
                <select class="form-select" name="difficulty" required>
                  <option value="">-- choose --</option>
                  <% for (let i = 0; i < difficulties.length; i++) { %>
                    <option value="<%= difficulties[i] %>" <%= values.difficulty === difficulties[i] ? 'selected' : '' %>><%= difficulties[i] %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Prep Time (mins)</label>
                <input class="form-control" type="number" name="prepTime" min="1" max="480" step="1" required value="<%= values.prepTime %>" />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Servings</label>
                <input class="form-control" type="number" name="servings" min="1" max="20" step="1" required value="<%= values.servings %>" />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Created Date</label>
              <input class="form-control" type="date" name="createdDate" value="<%= values.createdDate %>" />
            </div>
          </div>
        </div>

        <!-- section 2 ingredients stored as text for easy server parsing -->
        <div class="card mb-4">
          <div class="card-header">Ingredients</div>
          <div class="card-body">
            <textarea class="form-control" name="ingredientsText" rows="6" required
              placeholder="One per line, like:
Rolled Oats | 60 | g
Milk | 250 | ml
Whey Protein | 30 | g"><%= values.ingredientsText %></textarea>
            <div class="form-text">Each line: <code>name | quantity | unit</code>. Units: pieces, kg, g, liters, ml, cups, tbsp, tsp, dozen.</div>
          </div>
        </div>

        <!-- section 3 free-form instructions, one step per line -->
        <div class="card mb-4">
          <div class="card-header">Instructions</div>
          <div class="card-body">
            <textarea class="form-control" name="instructionsText" rows="6" required placeholder="One step per line"><%= values.instructionsText %></textarea>
          </div>
        </div>

        <!-- helpful navigation plus the primary submit action -->
        <div class="d-flex justify-content-between">
          <a class="btn btn-outline-secondary" href="/recipes-list-<%= appId %>?userId=<%= userId %>">View Recipes</a>
          <button class="btn btn-primary" type="submit">Add Recipe</button>
        </div>

      </form>

      <script>
        (function () {
          // reference the current application instance so API calls hit the right endpoint
          const APP_ID = '<%= appId %>';

          // collect the elements we will need for client-side validation
          const form = document.querySelector('form');
          const recipeIdInput = form.querySelector('input[name="recipeId"]');
          const ingredientsInput = form.querySelector('textarea[name="ingredientsText"]');

          function toTrimmed(str) {
            if (typeof str !== 'string') return '';
            return str.trim();
          }

          // ensure every ingredient entry follows the name | quantity | unit rule
          function validateIngredients() {
            ingredientsInput.setCustomValidity('');
            const text = ingredientsInput.value || '';
            const lines = text.split(/\r?\n/);
            let ok = true;

            for (let i = 0; i < lines.length; i++) {
              const line = toTrimmed(lines[i]);
              if (!line) continue;
              const parts = line.split('|');
              if (parts.length !== 3) { ok = false; break; }

              const name = toTrimmed(parts[0]);
              const qtyStr = toTrimmed(parts[1]);
              const unit = toTrimmed(parts[2]).toLowerCase();
              const qty = Number(qtyStr);

              if (!name || !Number.isFinite(qty) || qty <= 0 || !unit) { ok = false; break; }
            }

            if (!ok) {
              ingredientsInput.setCustomValidity('Ingredients must follow the "name | quantity | unit" format.');
            }

            return ok;
          }

          // ping the recipes API to avoid duplicate recipe IDs
          function checkDuplicateId(cb) {
            recipeIdInput.setCustomValidity('');

            const wantId = toTrimmed(recipeIdInput.value);
            if (!wantId) { cb(false); return; }

            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/recipes-list-' + APP_ID, true);
            xhr.onreadystatechange = function () {
              if (xhr.readyState === 4) {
                let isDup = false;

                if (xhr.status >= 200 && xhr.status < 300) {
                  try {
                    const data = JSON.parse(xhr.responseText || '{}');
                    const list = (data && data.recipes) ? data.recipes : [];
                    for (let i = 0; i < list.length; i++) {
                      const r = list[i];
                      if (r && r.recipeId === wantId) { isDup = true; break; }
                    }
                  } catch (e) {}
                }
                if (isDup) {
                  recipeIdInput.setCustomValidity('Recipe ID already exists.');
                } else {
                  recipeIdInput.setCustomValidity('');
                }

                cb(isDup);
              }
            };
            try { xhr.send(); } catch (e) { cb(false); }
          }

          ingredientsInput.addEventListener('input', function () {
            validateIngredients();
            if (typeof ingredientsInput.reportValidity === 'function') {
              ingredientsInput.reportValidity();
            }
          });

          recipeIdInput.addEventListener('input', function () {
            recipeIdInput.setCustomValidity('');
            if (typeof recipeIdInput.reportValidity === 'function') {
              recipeIdInput.reportValidity();
            }
          });

          recipeIdInput.addEventListener('blur', function () {
            checkDuplicateId(function () {
              if (typeof recipeIdInput.reportValidity === 'function') {
                recipeIdInput.reportValidity();
              }
            });
          });

          form.addEventListener('submit', function (e) {
            e.preventDefault();

            recipeIdInput.setCustomValidity('');
            validateIngredients();

            checkDuplicateId(function () {
              if (form.checkValidity()) {
                form.submit();
              } else {
                if (typeof form.reportValidity === 'function') {
                  form.reportValidity();
                } else {
                  const firstInvalid = form.querySelector(':invalid');
                  if (firstInvalid) firstInvalid.focus();
                }
              }
            });
          });
        })();
      </script>
    </div>
  </body>
</html>